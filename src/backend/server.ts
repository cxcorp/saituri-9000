import bodyParser from "body-parser";
import express from "express";
import type { Express } from "express";
import { createExpenseGroupApi } from "./expenseGroupApi.js";
import { createMemberApi } from "./memberApi.js";
import basicAuth from "express-basic-auth";
import { BackendContext } from "./context.js";
import { pinoHttp } from "pino-http";
import { Request } from "express";
import { Response } from "express";
import { NextFunction } from "express";
import cookieParser from "cookie-parser";

export async function createServer(context: BackendContext, injectRoutes?: (server: Express) => void) {
  const { env, config, logger } = context;
  const { port, basicAuth: basicAuthConfig } = config;

  const server = express();
  server.use(bodyParser.json());
  server.use(cookieParser())

  const httpLogger = pinoHttp({
    logger: context.logger,
  });

  server.use(httpLogger);

  if (basicAuthConfig) {
    const { user, password } = basicAuthConfig;
    logger.info(`Basic auth enabled for user ${user}`);
    server.use(
      basicAuth({
        users: { [user]: password },
        challenge: true,
      }),
    );
  } else if (env === "production") {
    logger.warn(
      "Basic auth is not enabled. Please set BASIC_AUTH_USER and BASIC_AUTH_PASSWORD environment variables to prevent unauthorized access.",
    );
  }

  if (injectRoutes) {
    injectRoutes(server);
  }

  // Serve bundles generated by Parcel
  server.use("/assets", express.static(config.assetPath, { index: false }));
  // Serve favicon
  server.use("/favicon.ico", express.static("public/favicon.ico"));

  server.get("/api/health", (_, res) => {
    res.send("OK");
  });

  server.use("/api", createExpenseGroupApi(context).handler());
  server.use("/api", createMemberApi(context).handler());

  // The "catchall" handler: for any request that doesn't
  // match one above, send back React's index.html file.
  server.get("*", (_, res) => {
    res.sendFile("index.html", { root: config.assetPath });
  });

  // Add error handler middleware
  server.use((err: unknown, req: Request, res: Response, _: NextFunction) => {
    logger.error({ err, url: req.url }, "Error handling request");
    res.sendStatus(500);
  })

  return new Promise((resolve) => {
    server.listen(port, () => {
      logger.info(`Server is running at http://localhost:${port}`);
      resolve(server);
    });
  });
}
